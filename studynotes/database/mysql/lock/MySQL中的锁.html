<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://aruni.me/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html"><meta property="og:site_name" content="AruNi's domain"><meta property="og:title" content="MySQL 中的锁"><meta property="og:description" content="本文内容 1. MySQL 中的锁有哪些 根据加锁的范围，MySQL 中的锁分为 全局锁、表锁和行级锁。 全局锁和表级锁是在 Server 层实现的，而行级锁是在存储引擎层实现的。 2. 全局锁 2.1 什么是全局锁 全局锁，顾名思义会对整个 MySQL 实例加锁，也就是锁库中所有的表。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-03-06T14:28:42.000Z"><meta property="article:tag" content="MySQL"><meta property="article:published_time" content="2023-02-21T00:00:00.000Z"><meta property="article:modified_time" content="2023-03-06T14:28:42.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"MySQL 中的锁","image":[""],"datePublished":"2023-02-21T00:00:00.000Z","dateModified":"2023-03-06T14:28:42.000Z","author":[]}</script><link rel="icon" href="/logo.svg"><title>MySQL 中的锁 | AruNi's domain</title><meta name="description" content="本文内容 1. MySQL 中的锁有哪些 根据加锁的范围，MySQL 中的锁分为 全局锁、表锁和行级锁。 全局锁和表级锁是在 Server 层实现的，而行级锁是在存储引擎层实现的。 2. 全局锁 2.1 什么是全局锁 全局锁，顾名思义会对整个 MySQL 实例加锁，也就是锁库中所有的表。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/docs/assets/style-858ac01f.css" as="style"><link rel="stylesheet" href="/docs/assets/style-858ac01f.css">
    <link rel="modulepreload" href="/docs/assets/app-f402e4a1.js"><link rel="modulepreload" href="/docs/assets/framework-3ccafb52.js"><link rel="modulepreload" href="/docs/assets/MySQL中的锁.html-361bf9c3.js"><link rel="modulepreload" href="/docs/assets/MySQL中的锁.html-ae633c73.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/docs/" class="brand"><img class="logo" src="/docs/logo.png" alt="AruNi&#39;s domain"><!----><span class="site-name hide-in-pad">AruNi&#39;s domain</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/docs/studynotes/" class="nav-link active" aria-label="学习笔记"><span class="font-icon icon iconfont icon-Notes" style=""></span>学习笔记<!----></a></div><div class="nav-item hide-in-mobile"><a href="/docs/lifetalk/" class="nav-link" aria-label="人生杂谈"><span class="font-icon icon iconfont icon-rensheng" style=""></span>人生杂谈<!----></a></div><div class="nav-item hide-in-mobile"><a href="/docs/updatelog/" class="nav-link" aria-label="更新日志"><span class="font-icon icon iconfont icon-rizhi" style=""></span>更新日志<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://aruni.me" rel="noopener noreferrer" target="_blank" aria-label="我的博客" class="nav-link"><span class="font-icon icon iconfont icon-blog" style=""></span>我的博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/AruNi-01/" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><div id="docsearch-container"></div><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">Java</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-database" style=""></span><span class="title">数据库</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="title">MySQL</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-basis" style=""></span><span class="title">基础</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/docs/studynotes/database/mysql/basis/MySQL%E5%B8%B8%E8%A7%81%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL 常见存储引擎"><span class="font-icon icon iconfont icon-write" style=""></span>MySQL 常见存储引擎<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/basis/select%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.html" class="nav-link sidebar-link sidebar-page" aria-label="select 执行流程"><span class="font-icon icon iconfont icon-write" style=""></span>select 执行流程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-mysql_index" style=""></span><span class="title">索引</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/docs/studynotes/database/mysql/index/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%B9%8Bexplain.html" class="nav-link sidebar-link sidebar-page" aria-label="执行计划之 explain"><span class="font-icon icon iconfont icon-write" style=""></span>执行计划之 explain<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/index/%E7%B4%A2%E5%BC%95%E8%A6%86%E7%9B%96%E5%92%8C%E7%B4%A2%E5%BC%95%E6%9D%A1%E4%BB%B6%E4%B8%8B%E6%8E%A8.html" class="nav-link sidebar-link sidebar-page" aria-label="索引覆盖和索引条件下推"><span class="font-icon icon iconfont icon-write" style=""></span>索引覆盖和索引条件下推<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/index/%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E4%B8%8E%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D.html" class="nav-link sidebar-link sidebar-page" aria-label="联合索引与最左前缀匹配"><span class="font-icon icon iconfont icon-write" style=""></span>联合索引与最左前缀匹配<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-mysql_log" style=""></span><span class="title">日志</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/docs/studynotes/database/mysql/log/redo%20log%EF%BC%9A%E5%B4%A9%E6%BA%83%E6%81%A2%E5%A4%8D%E7%A5%9E%E5%99%A8.html" class="nav-link sidebar-link sidebar-page" aria-label="redo log：崩溃恢复神器"><span class="font-icon icon iconfont icon-write" style=""></span>redo log：崩溃恢复神器<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/log/binlog%EF%BC%9A%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E5%A4%87%E4%BB%BD.html" class="nav-link sidebar-link sidebar-page" aria-label="binlog：主从复制和备份"><span class="font-icon icon iconfont icon-write" style=""></span>binlog：主从复制和备份<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/log/update%20%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.html" class="nav-link sidebar-link sidebar-page" aria-label="update 执行流程"><span class="font-icon icon iconfont icon-write" style=""></span>update 执行流程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/log/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E6%9C%89%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98.html" class="nav-link sidebar-link sidebar-page" aria-label="两阶段提交有什么问题"><span class="font-icon icon iconfont icon-write" style=""></span>两阶段提交有什么问题<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/log/undo%20log%EF%BC%9A%E4%B8%96%E4%B8%8A%E7%9C%9F%E6%9C%89%E5%90%8E%E6%82%94%E8%8D%AF.html" class="nav-link sidebar-link sidebar-page" aria-label="undo log：世上真有后悔药"><span class="font-icon icon iconfont icon-write" style=""></span>undo log：世上真有后悔药<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-mysql_transaction" style=""></span><span class="title">事务</span><!----></p><ul class="sidebar-links"></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-mysql_pool" style=""></span><span class="title">缓冲池</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/docs/studynotes/database/mysql/buffer_pool/%E4%BA%86%E8%A7%A3BufferPool.html" class="nav-link sidebar-link sidebar-page" aria-label="了解 Buffer Pool"><span class="font-icon icon iconfont icon-write" style=""></span>了解 Buffer Pool<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/studynotes/database/mysql/buffer_pool/%E6%8F%90%E9%AB%98%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E7%8E%87%E7%9A%84LRU%E9%93%BE%E8%A1%A8.html" class="nav-link sidebar-link sidebar-page" aria-label="提高缓存命中率的 LRU 链表"><span class="font-icon icon iconfont icon-write" style=""></span>提高缓存命中率的 LRU 链表<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-mysql_lock" style=""></span><span class="title">锁</span><!----></p><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="MySQL 中的锁"><span class="font-icon icon iconfont icon-write" style=""></span>MySQL 中的锁<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_1-mysql-中的锁有哪些" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. MySQL 中的锁有哪些"><!---->1. MySQL 中的锁有哪些<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-全局锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. 全局锁"><!---->2. 全局锁<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-1-什么是全局锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 什么是全局锁"><!---->2.1 什么是全局锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-2-全局锁的使用场景" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 全局锁的使用场景"><!---->2.2 全局锁的使用场景<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-表级锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. 表级锁"><!---->3. 表级锁<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-1-表锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1 表锁"><!---->3.1 表锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-2-元数据锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2 元数据锁"><!---->3.2 元数据锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-3-意向锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.3 意向锁"><!---->3.3 意向锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-4-auto-inc-锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.4 AUTO-INC 锁"><!---->3.4 AUTO-INC 锁<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-行级锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. 行级锁"><!---->4. 行级锁<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-1-两阶段锁协议" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 两阶段锁协议"><!---->4.1 两阶段锁协议<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-2-record-lock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 Record Lock"><!---->4.2 Record Lock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-3-gap-lock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 Gap Lock"><!---->4.3 Gap Lock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-4-next-key-lock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4 Next-Key Lock"><!---->4.4 Next-Key Lock<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_5-总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5. 总结"><!---->5. 总结<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_6-参考文章" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6. 参考文章"><!---->6. 参考文章<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-redis" style=""></span><span class="title">Redis</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-computer" style=""></span><span class="title">计算机基础</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-framework" style=""></span><span class="title">框架</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-a-structure4-fill" style=""></span><span class="title">LeetCode 算法</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-middleware" style=""></span><span class="title">中间件</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-design-pattern" style=""></span><span class="title">设计模式</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="font-icon icon iconfont icon-write" style=""></span>MySQL 中的锁</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/AruNi-01/" target="_blank" rel="noopener noreferrer">AruNi_Lu</a></span><span property="author" content="AruNi_Lu"></span></span><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-21T00:00:00.000Z"></span><span class="page-word-info" aria-label="字数🔠" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 5065 字</span><meta property="wordCount" content="5065"></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 17 分钟</span><meta property="timeRequired" content="PT17M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category6 clickable" role="navigation">数据库</span><meta property="articleSection" content="数据库"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag3 clickable" role="navigation">MySQL</span><meta property="keywords" content="MySQL"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_1-mysql-中的锁有哪些" class="router-link-active router-link-exact-active toc-link level2">1. MySQL 中的锁有哪些</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-全局锁" class="router-link-active router-link-exact-active toc-link level2">2. 全局锁</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-1-什么是全局锁" class="router-link-active router-link-exact-active toc-link level3">2.1 什么是全局锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-2-全局锁的使用场景" class="router-link-active router-link-exact-active toc-link level3">2.2 全局锁的使用场景</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-表级锁" class="router-link-active router-link-exact-active toc-link level2">3. 表级锁</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-1-表锁" class="router-link-active router-link-exact-active toc-link level3">3.1 表锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-2-元数据锁" class="router-link-active router-link-exact-active toc-link level3">3.2 元数据锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-3-意向锁" class="router-link-active router-link-exact-active toc-link level3">3.3 意向锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-4-auto-inc-锁" class="router-link-active router-link-exact-active toc-link level3">3.4 AUTO-INC 锁</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-行级锁" class="router-link-active router-link-exact-active toc-link level2">4. 行级锁</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-1-两阶段锁协议" class="router-link-active router-link-exact-active toc-link level3">4.1 两阶段锁协议</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-2-record-lock" class="router-link-active router-link-exact-active toc-link level3">4.2 Record Lock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-3-gap-lock" class="router-link-active router-link-exact-active toc-link level3">4.3 Gap Lock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-4-next-key-lock" class="router-link-active router-link-exact-active toc-link level3">4.4 Next-Key Lock</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_5-总结" class="router-link-active router-link-exact-active toc-link level2">5. 总结</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_6-参考文章" class="router-link-active router-link-exact-active toc-link level2">6. 参考文章</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><details class="hint-container details"><summary>本文内容</summary><nav class="table-of-contents"><ul><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_1-mysql-中的锁有哪些" class="router-link-active router-link-exact-active">1. MySQL 中的锁有哪些</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-全局锁" class="router-link-active router-link-exact-active">2. 全局锁</a><ul><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-1-什么是全局锁" class="router-link-active router-link-exact-active">2.1 什么是全局锁</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_2-2-全局锁的使用场景" class="router-link-active router-link-exact-active">2.2 全局锁的使用场景</a></li></ul></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-表级锁" class="router-link-active router-link-exact-active">3. 表级锁</a><ul><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-1-表锁" class="router-link-active router-link-exact-active">3.1 表锁</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-2-元数据锁" class="router-link-active router-link-exact-active">3.2 元数据锁</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-3-意向锁" class="router-link-active router-link-exact-active">3.3 意向锁</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_3-4-auto-inc-锁" class="router-link-active router-link-exact-active">3.4 AUTO-INC 锁</a></li></ul></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-行级锁" class="router-link-active router-link-exact-active">4. 行级锁</a><ul><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-1-两阶段锁协议" class="router-link-active router-link-exact-active">4.1 两阶段锁协议</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-2-record-lock" class="router-link-active router-link-exact-active">4.2 Record Lock</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-3-gap-lock" class="router-link-active router-link-exact-active">4.3 Gap Lock</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_4-4-next-key-lock" class="router-link-active router-link-exact-active">4.4 Next-Key Lock</a></li></ul></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_5-总结" class="router-link-active router-link-exact-active">5. 总结</a></li><li><a aria-current="page" href="/docs/studynotes/database/mysql/lock/MySQL%E4%B8%AD%E7%9A%84%E9%94%81.html#_6-参考文章" class="router-link-active router-link-exact-active">6. 参考文章</a></li></ul></nav></details><h2 id="_1-mysql-中的锁有哪些" tabindex="-1"><a class="header-anchor" href="#_1-mysql-中的锁有哪些" aria-hidden="true">#</a> <strong>1. MySQL 中的锁有哪些</strong></h2><p>根据加锁的范围，MySQL 中的锁分为 <strong>全局锁、表锁和行级锁</strong>。</p><p>全局锁和表级锁是在 Server 层实现的，而行级锁是在存储引擎层实现的。</p><h2 id="_2-全局锁" tabindex="-1"><a class="header-anchor" href="#_2-全局锁" aria-hidden="true">#</a> <strong>2. 全局锁</strong></h2><h3 id="_2-1-什么是全局锁" tabindex="-1"><a class="header-anchor" href="#_2-1-什么是全局锁" aria-hidden="true">#</a> <strong>2.1 什么是全局锁</strong></h3><p>全局锁，顾名思义会对整个 MySQL 实例加锁，也就是锁库中所有的表。</p><p>加了全局锁后，<strong>整个数据库就处于只读状态</strong>，其他线程执行 DML、DDL 都会被阻塞。</p><p>MySQL 中关于全局锁的命令：</p><ul><li><p>加全局锁：<code>flush tables with read lock</code>（简称 FTWRL）。</p></li><li><p>释放全局锁：<code>unlock tables</code>，连接会话断开也会自动释放。</p></li></ul><h3 id="_2-2-全局锁的使用场景" tabindex="-1"><a class="header-anchor" href="#_2-2-全局锁的使用场景" aria-hidden="true">#</a> <strong>2.2 全局锁的使用场景</strong></h3><p>全局锁的一个典型使用场景就是 <strong>全库逻辑备份</strong>，也就是把数据库中每个表的所有记录都查询出来保存。</p><p>进行全库逻辑备份的时候，需要让备份的数据和数据库的数据保持一致性，所以肯定是需要加锁的。</p><p>假设在备份的时候不加锁，会出现什么情况呢？</p><p>比如用户在购物网站上买东西，数据库表的备份顺序可能是下面这样的：</p><ul><li>先备份有用户余额的表；</li><li>接着用户点击下单，扣除余额，减少商品库存；</li><li>最后备份商品表。</li></ul><p>可以发现备份的数据中，用户的余额还是原来的，但是商品的库存却减少了，资本家能允许这样的事情发生？</p><p>所以，在全库逻辑备份时，需要加上全局锁，那么上面用户下单的操作，就会被阻塞。</p><p>那如果有许多剁手党刚好在备份的这个时间段剁手呢？总不能让这些财神爷白白的等待数据库备份完成吧。</p><p>在 InnoDB 存储引擎下，事务的隔离级别为 <strong>REPEATABLE READ</strong> 时，每次开始事务时会开启一个 ReadView，<strong>这个 ReadView 是具有一致性的</strong>，即这个事务过程中看到的数据都是一致的。</p><p>所以官方自带了一个逻辑备份的工具，是 <strong>mysqldump</strong>。当 mysqldump 使 用参数 <strong>-single-transaction</strong> 时，导出数据之前就会开启一个事务，<strong>确保在这个事务中的数据是一致的</strong>。由于 MVCC 的支持，这个过程中数据是可以正常更新的（备份过程中更新的记录不会保留到备份的数据里，这才满足一致性要求）。</p><blockquote><p>MVCC 和 ReadView 在 InnoDB 里面是非常重要的，如果你还不了解 ，可以看看相关的文章。</p></blockquote><p>所以，<strong>在支持 REPEATABLE READ 这个隔离级别的存储引擎中（比如 InnoDB），可以使用这个一致性视图来进行备份</strong>，但是如果不支持（比如 MyISAM），那就只能使用全局锁来备份了。</p><h2 id="_3-表级锁" tabindex="-1"><a class="header-anchor" href="#_3-表级锁" aria-hidden="true">#</a> <strong>3. 表级锁</strong></h2><p>MySQL 中的表级锁有下面几种：</p><ul><li><strong>表锁</strong>（注意表锁属于表级锁的一种）；</li><li><strong>元数据所 MDL</strong>（Meta Data Lock）；</li><li><strong>意向锁</strong></li><li><strong>AUTO-INC 锁</strong>（主键自增锁）；</li></ul><h3 id="_3-1-表锁" tabindex="-1"><a class="header-anchor" href="#_3-1-表锁" aria-hidden="true">#</a> <strong>3.1 表锁</strong></h3><p>关于表锁的相关命令：</p><ul><li>加共享式表锁：<code>lock tables xx_table read</code>；</li><li>加独占式表锁：<code>lock tables xx_table write</code>；</li><li>释放表锁：和全局锁一样，使用 <code>unlock tables</code>，连接会话断开也会自动释放。</li></ul><p>注意：表锁除了会限制别的线程的读写外，<strong>也会限制本线程接下来的读写操作</strong>。</p><p>例如，线程 A 执行了 <code>lock tables t1 read, t2 write;</code>，那么其他线程写 t1、读写 t2 都会被阻塞。同时，<strong>在线程 A 释放锁之前，执行写 t1 也会被阻塞</strong>。</p><p>不过对于 InnoDB 这种支持行级锁的存储引擎来说，我们一般不使用表锁，因为它的锁粒度太大，对并发性能有很大的影响。</p><h3 id="_3-2-元数据锁" tabindex="-1"><a class="header-anchor" href="#_3-2-元数据锁" aria-hidden="true">#</a> <strong>3.2 元数据锁</strong></h3><h4 id="_3-2-1-什么是元数据锁" tabindex="-1"><a class="header-anchor" href="#_3-2-1-什么是元数据锁" aria-hidden="true">#</a> <strong>3.2.1 什么是元数据锁</strong></h4><p><strong>元数据锁 MDL 主要作用于 DML 语句（CRUD）和 DDL 语句（改变表结构）</strong>，它能保证读写的正确性。例如一个查询正在遍历一个表中的数据时，另一个线程此时改变了表的结构，删了一列，就会导致查询到的结果与表结构对不上，这肯定是不行的。</p><p>MDL 不需要我们显示使用，当我们对表执行相关操作时，MySQL 会自动给表加上 MDL：</p><ul><li><p>对表做 <strong>CRUD</strong> 时，对表加 <strong>DML 读锁</strong>；</p><blockquote><p>DML 读读锁是不互斥的，所以可以有多个线程同时对一张表做 CRUD。 但是加了 DML 读锁时，一旦有线程对表结构做修改，就会被阻塞。</p></blockquote></li><li><p>对表做 <strong>结构改变</strong> 时，对表加 <strong>DML 写锁</strong>。</p><blockquote><p>DML 的读写锁、写写锁之间是互斥的，例如加了 DML 写锁后，连 select 也会被阻塞。</p></blockquote></li></ul><p>既然 MDL 不需要我们显示使用，那它什么时候被释放呢？这是个重点，<strong>MDL 在事务结束后才会被释放</strong>。</p><h4 id="_3-2-2-元数据锁带来的坑" tabindex="-1"><a class="header-anchor" href="#_3-2-2-元数据锁带来的坑" aria-hidden="true">#</a> <strong>3.2.2 元数据锁带来的坑</strong></h4><p>我们知道 MDL 在事务结束后才会被释放，也就是说 <strong>在事务执行期间，MDL 是一直存在的</strong>，由此可以看出，<strong>在长事务中做表结构的更改时，可能会出现一些坑</strong>。</p><p>在给一个数据量很大的大表添加字段，或修改字段时，需要扫描全表的数据。因为要修改每一行记录中对应列的数据。另外在加索引时，也需要扫描全表的数据来创建索引。所以我们在对大表做以上操作时，肯定会格外的小心，避免对线上业务造成影响。</p><p>那我们对一个小表，就可以随意进行上面的操作了吗？实际上不是的，操作不慎也会出现问题，而且问题还不小。例如下面这个操作序列：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202302202028412.png" alt="image-20230220202758945"></p><ul><li>session A 开始一个事务后，执行 select 操作，此时的表会加 MDL 读锁；</li><li>session B 也执行 select 操作，此时不会被阻塞，因为 MDL 读读锁不互斥；</li><li>session C 执行 DDL 操作，<strong>需要申请 DML 写锁</strong>，但此时 session A 事务还未关闭，表还有 MDL 读锁，所以 <strong>session C 被阻塞</strong>；</li></ul><p>此时不会有什么问题，<strong>但是后面如果还有线程在这个表上申请 MDL 读锁，就会被阻塞</strong>。</p><p>因为 <strong>申请 DML 锁的操作会被放入一个队列，队列中写锁获取的优先级高于读锁。故一旦某个表的 DML 写锁进入阻塞状态时，该表后面的所有操作都将被阻塞</strong>。</p><p>如果这个表此时有大量的查询请求到来，又都被阻塞了，<strong>那这个库的线程很快就会爆满</strong>。</p><p>所以在对表结构做修改之前，要先看看数据库中是否有长事务，然后再做对应的修改。</p><h3 id="_3-3-意向锁" tabindex="-1"><a class="header-anchor" href="#_3-3-意向锁" aria-hidden="true">#</a> <strong>3.3 意向锁</strong></h3><p>在 InnoDB 存储引擎中是支持行级锁的，那么我们 <strong>在对记录加行锁时，会先在表级别上加一个对应的意向锁</strong>：</p><ul><li>如果对记录加共享锁，那么会在表上加意向共享锁；</li><li>如果对记录加独占锁，那么会在表上加意向独占锁。</li></ul><p>所以 <strong>在增删改操作时，会先在表上加意向独占锁，然后对某条记录加行锁</strong>。InnoDB 中普通的 select 是不需要加锁的，通过 MVCC 来实现一致性读。</p><p><strong>意向锁</strong> 的提出是为了能够在 O(1) 的时间复杂度 <strong>判断到某个表中的记录是否有锁</strong>。</p><p>设想一下，如果我要对表加独占式的表锁，由于读写、写写都是互斥的，所以我要知道表中是否有加了读锁或写锁的记录，如果没有意向锁，那么就需要去遍历表中的记录来判断是否有记录加了锁。而如果有意向锁，在加独占式的表锁时，就可直接根据该表是否有意向锁来判断。</p><p>注意：<strong>意向锁虽然是表级锁，但是不会和行级别的锁发生冲突，而且意向锁之间也不会发生冲突。它的提出仅仅是为了能快速判断一个表里是否有记录被加锁了</strong>。</p><h3 id="_3-4-auto-inc-锁" tabindex="-1"><a class="header-anchor" href="#_3-4-auto-inc-锁" aria-hidden="true">#</a> <strong>3.4 AUTO-INC 锁</strong></h3><p>我们在定义主键时，可以将主键设置成自增的，之后在插入数据的时候，就无需输入主键，MySQL 会 <strong>自动给主键赋上递增的值</strong>，这主要就是 <strong>通过 AUTO-INC 锁来实现的</strong>。</p><p>AUTO-INC 锁并不是等事务结束后才释放，而是 <strong>执行完插入语句就会立即释放</strong>，以便其他事务再申请。</p><p>AUTO-INC 锁保证了被设置成自增的主键是连续递增的，一个事务在插入记录时，会给该表加一个 AUTO-INC 锁（表级锁），这样当其他事务执行插入操作时，就会被阻塞。</p><p>不过，当有多个事务进行数据的插入时，性能无疑会受到影响。</p><p>所以后面 InnoDB 存储引擎提供了一种 <strong>轻量级的锁</strong> 来实现自增：</p><ul><li>当执行插入操作时，<strong>给主键赋上一个自增的值后，就可以把这个锁释放了</strong>，无需等待整个插入语句执行完。</li></ul><p>InnoDB 提供了一个系统变量 <code>innodb_autoinc_lock_mode</code> 来控制自增锁的类型：</p><ul><li>参数 = 0，AUTO-INC 锁；</li><li>参数 = 2，轻量级锁；</li><li>参数 = 1（默认值）： <ul><li>普通 insert：轻量级锁；</li><li>批量插入（<code>insert ... select</code>）：AUTO-INC 锁。</li></ul></li></ul><p>你肯定会想，轻量级锁效率这么高，为什么这个变量的默认值不是 2 呢？</p><p>这是因为，<strong>在批量插入时，如果使用轻量级锁可能会造成数据不一致</strong>。例如下面这个场景：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202302202150611.png" alt="image-20230220215028676"></p><p>在这个例子里，往表 t1 中插入了 4 行数据，然后创建了一个相同结构的表 t2，然后 <strong>两个 session 同时执行向表 t2 中插入数据</strong>。</p><p>如果使用轻量级锁，在申请完自增主键后就释放锁，那么可能会出现下面这样的情况：</p><ul><li>session B 先插入两个记录 (1,1,1)、(2,2,2)；</li><li>这时，<strong>session A 恰巧申请到自增 id = 3，插入 (3,5,5)</strong>；</li><li>最后，session B 继续插入 (4,3,3)、(5,4,4)。</li></ul><p>可以发现，session B 在批量插入时，被 session A 插队了，导致 <strong>session B 插入的记录 id 不连续</strong>。这会有什么问题呢？</p><p>如果我们现在的 binlog_format = statement（即 binlog 记录的是原始 SQL 语句，而不是具体的数据），那么 binlog 会怎么记录？</p><p>由于两个 session 是同时执行插入数据命令的，所以 binlog 里面对表 t2 的更新日志只有两种情况：<strong>要么先记 session A 的，要么先记 session B 的</strong>，因为 <strong>一个事务中的 binlog 是不能被拆开的</strong>。</p><p>但不论是哪一种，这个 binlog 拿去从库执行，或者用来恢复临时实例，表 t2 中的数据是下面这样的：</p><ul><li>先记 session A，再记 session B：(1,5,5)、(2,1,1)、(3,2,2)、(4,3,3)、(5,4,4)；</li><li>先记 session B，再记 session A：(1,1,1)、(2,2,2)、(3,3,3)、(4,4,4)、(5,5,5)；</li></ul><p>可以发现，从库或临时实例里面，<strong>session B 这个语句执行出来的结果，id 都是连续的</strong>。这时，该库就发生了 <strong>数据不一致</strong>。</p><p>其实，这个原因就是 <strong>原库 session B 的 insert 语句，生成的 id 不连续。这个不连续的 id，用 statement 格式的 binlog 来串行执行，是执行不出来的，是得不到不连续的 id 的</strong>。</p><p>要解决这个问题有两个思路：</p><ul><li>让原库 <strong>批量插入</strong> 数据时，<strong>不使用轻量级锁</strong>，binlog 的格式随意；</li><li><strong>binlog 格式设为 row，批量插入也可以使用轻量级锁</strong>；</li></ul><p>但是还是建立采用思路二，即 <strong>binlog_format = row ，并且 innodb_autoinc_lock_mode = 2</strong>，这样做既能提升并发性能，又不会出现数据一致性问题。</p><h2 id="_4-行级锁" tabindex="-1"><a class="header-anchor" href="#_4-行级锁" aria-hidden="true">#</a> <strong>4. 行级锁</strong></h2><p>行级锁是由存储引擎实现的，常见的 <strong>InnoDB 就支持行级锁</strong>，而 MyISAM 不支持。</p><p>普通的 select 语句 <strong>不需要加锁</strong>，这种查询操作称为快照读，是通过 MVCC 机制来实现的。</p><p>但是我们也可以 <strong>显示的给 select 语句加锁</strong>，这种读操作称为 <strong>当前读</strong>，或者 <strong>锁定读</strong>，加锁方式如下：</p><ul><li>对读取的记录加共享锁：<code>select ... lock in share mode;</code>；</li><li>对读取的记录加独占锁：<code>select ... for update;</code>。</li></ul><blockquote><p>insert、delete、update 操作也是属于当前读，它们会获取数据的最新版本。</p></blockquote><p><strong>当前读会获取数据的最新版本，而且需要先获取到对应记录的锁</strong>。</p><div class="hint-container info"><p class="hint-container-title">注意：</p><p>上面的语句 <strong>需要在事务中执行</strong>，因为它们申请到的锁，<strong>在事务结束时才会被释放</strong>。而 MySQL 默认开启事务自动提交，即每条 SOL 语句都会被当做一个单独的事务自动执行提交。</p><p>所以我们在执行上面的语句时，需要显式的开启事务（BEGIN 或 START TRANSACTION），或者关闭自动提交（SET autocommit = 0），否则上面的语句在数据读取完后就释放锁了。</p></div><p>InnoDB 中主要通过 Next-Key Lock 来实现当前读，<strong>Next-Key Lock</strong> 由 <strong>Record Lock</strong>（记录锁）和 <strong>Gap Lock</strong>（间隙锁）组成。下面主要来介绍这三种锁，行级锁的类型也主要是这三种。</p><h3 id="_4-1-两阶段锁协议" tabindex="-1"><a class="header-anchor" href="#_4-1-两阶段锁协议" aria-hidden="true">#</a> <strong>4.1 两阶段锁协议</strong></h3><p>在讲行级锁之前，先来看看什么是两阶段锁协议。其实我们上面也提到了，在事务结束时才会释放锁。</p><p>在 InnoDB 中，<strong>两阶段锁协议</strong> 的含义指：<strong>行锁是在需要时才加上，但是并不是不需要了就立马释放，而是需要等到事务结束（ROLLBACK or COMMIT）时才释放</strong>。</p><p>知道了这个协议，对我们使用事务和行锁有什么帮助呢？那就是，如果我们的事务中需要锁多个行，那么应该将可能造成锁冲突、影响并发量的锁往后放。</p><blockquote><p>由于两阶段锁协议，如果把锁放前面，那么并发操作时，假设一个事务先获取前面的锁，此时该事务后面还有很多与此锁无关的操作（迟迟不提交），那么就相对于该事务白白占用了这把锁，导致其他事务需要获取该锁时，阻塞的时间就比较长。</p></blockquote><p>假设让你负责一个影院电影票交易系统，顾客 1 要在影院 A 买票，该业务简化后的操作如下：</p><ol><li>从顾客 1 账户余额扣除票价；</li><li>给影院 A 账户余额增加票价；</li><li>记录一条交易日志。</li></ol><p>为了保证原子性，这三个操作肯定要放到同一个事务中执行。那么如何安排这三个操作的顺序呢？</p><p>我们常见的场景是多名客户在同一家影院买票，即此时还有其他客户 2、3、4 ... 也在影院 A 买票，那么这几个事务冲突的操作就是第二条，因为他们都需要给影院的账户余额增加票价。</p><p>按照上面的思路，我们将可能造成锁冲突的操作二放到最后，执行顺序改为 3、1、2，这样就能使得操作二中的锁加锁时间最短，从而大大提高并发度。</p><h3 id="_4-2-record-lock" tabindex="-1"><a class="header-anchor" href="#_4-2-record-lock" aria-hidden="true">#</a> <strong>4.2 Record Lock</strong></h3><p><strong>Record Lock</strong> 称为记录锁，顾名思义，<strong>它只锁一行记录</strong>。记录锁也有 S 锁（共享锁）和 X 锁（排他锁）之分。</p><p>例如，我们执行下面这条 SQL 语句：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>	<span class="token comment">// 记得开启事务</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在事务结束之前，id = 1 这行记录都会持有 X 型的记录锁，其他事务就不可以对此记录加 S 型或 X 型的记录锁了。</p><p>事务结束后，这个事务持有的锁就会被释放。</p><h3 id="_4-3-gap-lock" tabindex="-1"><a class="header-anchor" href="#_4-3-gap-lock" aria-hidden="true">#</a> <strong>4.3 Gap Lock</strong></h3><p><strong>Gap Lock</strong> 称为间隙锁，它的加锁方式是在 <strong>两条记录的缝隙加锁，即两记录之间（前开后开区间）</strong>。</p><p>为什么要在缝隙加锁呢？两条记录之间的缝隙又没有记录，既然锁不到记录，要它干什么？还会影响我插入。</p><p>诶，你提到了会影响你插入，为什么它要阻止你插入呢？难道是你还未满 18？🫣</p><p>哈哈哈回到正题，这时候不知道你有没有想到事务中的 <strong>幻读</strong>，就是 <strong>一个事务中读取到的记录数量会出现不一致的情况，注意是记录的数量</strong>。</p><p>例如我在事务 A 中一开始根据某个条件查询出的记录数量为 n，在事务结束之前，我再查，结果发现此时的记录数量为 n + 1，这就出现的幻读。</p><p>所以 <strong>间隙锁的提出就是为了解决上面这种情况的幻读</strong>。</p><p>需要注意的是，<strong>间隙锁只在可重复读（REPEATABLE READ）隔离级别出现，它的提出只是为了解决可重复读隔离级别下的幻读问题</strong>。</p><p>间隙锁虽然也有 X 型和 S 型之分，但是 <strong>间隙锁之间是兼容的</strong>。也就是不同事务中可以持有同一个区间的间隙锁，因为 <strong>间隙锁只是防止插入幻影记录而提出的，只用于防止在这个区间插入数据</strong>。</p><h3 id="_4-4-next-key-lock" tabindex="-1"><a class="header-anchor" href="#_4-4-next-key-lock" aria-hidden="true">#</a> <strong>4.4 Next-Key Lock</strong></h3><p><strong>Next-Key Lock</strong> 称为临键锁，是 <strong>Record Lock 和 Gap Lock 的组合，它会锁记录本身和一个间隙</strong>。</p><blockquote><p>Gap Lock 加的锁是前开后开区间，Next-Key Lock 是前开后闭，具体看 MySQL 的加锁规则。</p></blockquote><p>所以 Next-Key Lock 既能保证记录不被修改，也能阻止其他事务在被锁的间隙插入记录。</p><p>需要注意，<strong>Gap Lock 之间是不冲突的，但由于 Next-Key Lock 中有记录锁（记录锁需要考虑冲突），所以 Next-Key Lock 之间会冲突</strong>。比如一个事务中获取了一个 X 型的 Next-Key Lock，那么其他事务就不能再获取相同范围的 Next-Key Lock 了。</p><h2 id="_5-总结" tabindex="-1"><a class="header-anchor" href="#_5-总结" aria-hidden="true">#</a> <strong>5. 总结</strong></h2><p>MySQL 中的锁分为全局锁、表级锁和行级锁，其中行级锁是在存储引擎层实现的，常用的 InnoDB 就支持行级锁。</p><p>全局锁会锁整个库中的所有表，一般用于全库逻辑备份，但在支持 MVCC 的存储引擎中，一般使用一致性图来备份，从而避免全局锁给业务带来的影响。</p><p>表级锁分为下面几种：</p><ul><li>表锁：锁一个表，锁粒度较大，一般不会使用；</li><li>元数据锁 MDL：主要作用于 DML 和 DDL 之间，不需要我们显示使用，事务结束后自动释放；</li><li>意向锁：为了快速判断一个表中是否有记录被上了锁；</li><li>AUTO-INC 锁：主键自增时使用的锁，可以降级为轻量级锁，在申请完主键后就释放锁，无需等到插入操作结束才释放。不过需要注意 binlog_format = statement 时的数据不一致问题。</li></ul><p>行级锁分为下面几种：</p><ul><li>Record Lock：记录锁，只锁一条记录；</li><li>Gap Lock：间隙锁，锁一个区间，只是为了防止幻影记录的插入，Gap Lock 之间是不冲突的；</li><li>Next-Key Lock：临键锁，是 Record Lock 和 Gap Lock 的组合，Next-Key Lock 之间会冲突。</li></ul><p>MySQL 中常见的锁到这里就介绍完了，但是本文章仅仅是介绍了锁的类型，并没有讲解 MySQL 中锁的加锁规则，也就是一条语句是如何加锁的。加锁规则会在后面的文章中讲解。</p><h2 id="_6-参考文章" tabindex="-1"><a class="header-anchor" href="#_6-参考文章" aria-hidden="true">#</a> <strong>6. 参考文章</strong></h2><ul><li>《MySQL 实战 45 讲》</li><li><a href="https://xiaolincoding.com" target="_blank" rel="noopener noreferrer">小林 coding<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><!----></div></footer><!----><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/docs/assets/app-f402e4a1.js" defer></script>
  </body>
</html>
